import json
import boto3
import uuid

s3_client = boto3.client("s3")
polly_client = boto3.client("polly")

DEST_BUCKET = "texttotalk-audio-bucket"  # change if needed


def lambda_handler(event, context):
    try:
        body = json.loads(event.get("body", "{}"))
        text = body.get("text")

        if not text:
            return response(400, {"error": "Text is required"})

        filename = str(uuid.uuid4()) + ".mp3"

        polly_response = polly_client.synthesize_speech(
            OutputFormat="mp3",
            Text=text,
            VoiceId="Salli"
        )

        audio_data = polly_response["AudioStream"].read()

        s3_client.put_object(
            Bucket=DEST_BUCKET,
            Key=filename,
            Body=audio_data,
            ContentType="audio/mpeg"
        )

        audio_url = "https://{}.s3.ap-south-1.amazonaws.com/{}".format(
            DEST_BUCKET, filename
        )

        return response(200, {
            "message": "Success",
            "audio_url": audio_url
        })

    except Exception as e:
        return response(500, {"error": str(e)})


def response(status_code, body):
    return {
        "statusCode": status_code,
        "headers": {
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Headers": "Content-Type",
            "Access-Control-Allow-Methods": "OPTIONS,POST"
        },
        "body": json.dumps(body)
    }
